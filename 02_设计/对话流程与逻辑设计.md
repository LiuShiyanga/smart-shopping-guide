# 对话流程与逻辑设计

## 1. 设计目标
- 支持多平台商品搜索、比较、推荐、问答等全流程智能对话
- 兼顾规则/状态机与机器学习（Rasa Core）灵活切换
- 保证对话自然流畅、可控、易扩展

## 2. 系统架构
- 多Agent协作，中央协调器调度
- 对话管理Agent负责意图识别、实体抽取、状态跟踪、策略决策、回复生成
- 结合规则/状态机与Rasa Core，支持多轮、上下文、澄清、引导等

## 3. 意图与实体体系
### 3.1 主要意图
- 商品搜索（SearchProduct）
- 商品比较（CompareProduct）
- 产品推荐（RecommendProduct）
- 产品问答（ProductQA）
- 筛选/排序（Filter/Sort）
- 结束/中断（End/Interrupt）
- 闲聊/问候（ChitChat）

### 3.2 主要实体
- 商品名（ProductName）
- 平台（Platform）
- 品牌（Brand）
- 价格区间（PriceRange）
- 参数/属性（Spec/Attribute）
- 人群/场景（UserScene）
- 比较维度（CompareField）

## 4. 对话状态机与流程图（文字描述）
- 初始状态：等待用户输入
- 意图识别：NLU模块识别意图与实体
- 状态转移：根据意图进入不同业务流程（搜索、比较、推荐、问答等）
- 参数收集：如缺少必要参数，自动追问（如预算、品牌、平台等）
- 业务处理：调用对应Agent获取数据
- 回复生成：模板化或NLG生成回复
- 结束/中断：识别用户结束意图或超时，归档会话

## 5. 典型场景详细流程
### 5.1 商品搜索
1. 用户：我想买蓝牙耳机
2. 系统：请问有预算或品牌偏好吗？
3. 用户：预算300元以内，品牌不限
4. 系统：为您找到以下商品...（卡片列表展示）
5. 用户：只看京东的
6. 系统：为您筛选京东平台商品...

### 5.2 商品比较
1. 用户：帮我比较小米12和iPhone 13
2. 系统：请问关注哪些方面？如价格、性能、口碑等
3. 用户：主要看拍照和续航
4. 系统：为您比较如下...（表格展示）

### 5.3 推荐
1. 用户：给妈妈买手机推荐
2. 系统：请问预算、品牌或其他需求？
3. 用户：预算2000左右，适合老人
4. 系统：为您推荐...（推荐理由+商品卡片）

### 5.4 产品问答
1. 用户：这款耳机防水吗？
2. 系统：为您查询...（直接回答或引导查看详情）

## 6. 异常与中断处理
- 参数缺失：自动追问，最多2次，仍无结果则引导人工或结束
- 无法识别意图：回复"请您换种说法"或提供示例
- 外部接口异常：友好提示"服务繁忙，请稍后再试"
- 用户中断/结束：归档会话，支持下次恢复

## 7. 话术模板与NLG策略
- 常见场景用模板化回复，保证准确性和速度
- 复杂开放式问题可调用大模型API生成
- 支持结构化信息（卡片、表格、列表）与自然语言混合输出
- 话术示例：
  - "为您找到以下商品..."
  - "请问您更关注哪些方面？"
  - "很抱歉，暂时无法获取该信息..."

## 8. 扩展机制
- 新意图/实体可通过配置和训练快速扩展
- 业务流程支持插件化、热更新
- 支持多语言、多平台适配

## 9. 评估与优化
- 对话质量评估：准确率、召回率、用户满意度、平均轮次等
- 日志采集与分析，持续优化NLU与对话策略
- 用户反馈闭环，驱动知识库和话术更新

## 10. 参考文档
- 《系统架构设计文档》
- 《API接口设计文档》
- 《数据库设计说明书》
- Rasa官方文档、对话系统最佳实践

---
如需流程图可后续补充。 